name: Main

env:
  PYTHON_VERSION: 3.13.3

on:
  pull_request:
    paths:
      - "**/**"
    types:
      - opened
      - reopened
      - synchronize
  push:
    branches:
      - main
    tags:
      - "**/**"

permissions: {}

jobs:
  label-pr:
    name: Label PR
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request }}
    permissions:
      contents: read
      pull-requests: write
    outputs:
      labels: ${{ steps.pr_labeler.outputs.all-labels }}
    steps:
      - name: PR labeler 🏷
        id: pr_labeler
        uses: actions/labeler@634933edcd8ababfe52f92936142cc22ac488b1b # v6.0.1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yaml
          sync-labels: true
          dot: true
      - name: Show labels 👀
        id: show_labels
        env:
          ALL_LABELS: ${{ steps.pr_labeler.outputs.all-labels }}
          NEW_LABELS: ${{ steps.pr_labeler.outputs.new-labels }}
        run: |
          echo "ALL_LABELS: ${{ env.ALL_LABELS }}"
          echo "NEW_LABELS: ${{ env.NEW_LABELS }}"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout 🛎️
        id: checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Install uv 🌴
        uses: astral-sh/setup-uv@557e51de59eb14aaaba2ed9621916900a91d50c6 # v6.6.1
        with:
          version: 0.8.17
      - name: Setup Python 🐍
        id: setup_python
        run: uv python install
      - name: Setup environment 🌴
        id: setup_environment
        run: uv sync --locked --all-extras --dev
      - name: Lint YAML files 🧪
        id: lint_yaml_files
        run: yamllint -c .yamllint.yaml --format github .
      - name: Lint Markdown files 🧪
        id: lint_markdown_files
        uses: DavidAnson/markdownlint-cli2-action@992badcdf24e3b8eb7e87ff9287fe931bcb00c6e # v20.0.0
        with:
          config: .markdownlint.yaml
          globs: .
      - name: Lint Python files 🧪
        id: lint_python_files
        run: uv run ruff check --output-format=github --preview .

  spell-check:
    name: Spell check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout 🛎️
        id: checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Run spell checking 🧪
        id: run_spell_checking
        uses: streetsidesoftware/cspell-action@dcd03dc3e8a59ec2e360d0c62db517baa0b4bb6d # v7.2.0
        with:
          root: .
          check_dot_files: true
          inline: error
          strict: true
          config: .cspell.json
          verbose: true
          incremental_files_only: false

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    needs:
      - lint
      - spell-check
    permissions:
      contents: read
    steps:
      - name: Checkout 🛎️
        id: checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Install uv 🌴
        uses: astral-sh/setup-uv@557e51de59eb14aaaba2ed9621916900a91d50c6 # v6.6.1
        with:
          version: 0.8.17
      - name: Setup Python 🐍
        id: setup_python
        run: uv python install
      - name: Setup environment 🌴
        id: setup_environment
        run: uv sync --locked --all-extras --dev
      - name: Run unit tests 🧪
        id: run_unit_tests
        run: uv run pytest -v

  run-examples:
    name: Run examples
    runs-on: ubuntu-latest
    needs:
      - lint
      - spell-check
    permissions:
      contents: read
    steps:
      - name: Checkout 🛎️
        id: checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Install uv 🌴
        uses: astral-sh/setup-uv@557e51de59eb14aaaba2ed9621916900a91d50c6 # v6.6.1
        with:
          version: 0.8.17
      - name: Setup Python 🐍
        id: setup_python
        run: uv python install
      - name: Setup environment 🌴
        id: setup_environment
        run: uv sync --locked --all-extras --dev
      - name: Run examples 🧪
        id: run_examples
        run: |
          echo "==> Running building examples"
          uv run python -m examples.building
          echo "==> Running city examples"
          uv run python -m examples.city
          echo "==> Running scenario examples"
          uv run python -m examples.scenario
          echo "==> Running kingdom examples"
          uv run python -m examples.kingdom

  alls-green:
    name: All checks passed
    if: always()
    runs-on: ubuntu-latest
    needs:
      - label-pr
      - lint
      - spell-check
      - unit-tests
      - run-examples
    permissions: {}
    steps:
      - uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # v1.2.2
        with:
          allowed-skips: label-pr
          jobs: ${{ toJSON(needs) }}
